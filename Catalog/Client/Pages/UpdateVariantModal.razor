@using System.ComponentModel.DataAnnotations
@inject IProductsClient ProductsClient

<EditForm Model="@this" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>Name</label>
        <InputText class="form-control" @bind-Value="Name" />
        <ValidationMessage For="() => Name" />
    </div>

    <div class="form-group">
        <label>Description</label>
        <InputTextArea class="form-control" @bind-Value="Description" />
        <ValidationMessage For="() => Description" />
    </div>

    <div class="form-group">
        <label>SKU</label>
        <InputText class="form-control" @bind-Value="SKU" />
        <ValidationMessage For="() => SKU" />
    </div>

    <div class="form-group">
        <label>Price</label>
        <InputNumber type="currency" class="form-control" @bind-Value="Price" />
        <ValidationMessage For="() => Price" />
    </div>

    <div class="form-group">
        @if (Options is not null)
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Options is not null)
                    {
                        @foreach (var option in Options)
                        {
                            <tr>
                                <td>@option.Name</td>

                                @if (option.Values is not null)
                                {
                                    <td>
                                        <MySelect Items="option.Values" @bind-Value="option.SelectedValue" Selector="(x) => x.Name" />
                                    </td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>

    <div class="mt-4">
        <button type="button" @onclick="async () => await Modal.CancelAsync()" class="btn btn-secondary me-2">Cancel</button>

        <button class="btn btn-primary me-2">Save</button>
    </div>

</EditForm>

@code {
    [CascadingParameter] BlazoredModalInstance Modal { get; set; }

    [Parameter] public string ProductId { get; set; }

    [Parameter] public ApiProductVariant Variant { get; set; }

    [Required]
    public string Name { get; set; }

    public string Description { get; set; }

    [Required]
    public string SKU { get; set; }

    [Required]
    public decimal Price { get; set; }

    public List<OptionVM> Options = new List<OptionVM>();

    protected override async Task OnInitializedAsync()
    {
        Name = Variant.Name;
        Description = Variant.Description;
        SKU = Variant.Sku;
        Price = Variant.Price.GetValueOrDefault();

        var options = await ProductsClient.GetProductOptionsAsync(ProductId);
        foreach(var option in options)
        {
            var vm = new OptionVM()
            {
                Id = option.Id,
                Name = option.Name,
            };

            Options.Add(vm);

            vm.Values.AddRange(
                await ProductsClient.GetProductOptionValuesAsync(ProductId, option.Id));

            var o = Variant.Options.FirstOrDefault(x => x.Name == option.Name);

            vm.SelectedValue = vm.Values.FirstOrDefault(x => x.Name == o?.Value);

            if(vm.SelectedValue is null)
            {
                vm.SelectedValue = vm.Values.FirstOrDefault();
            }
        }
    }

    async Task OnSubmit()
    {
        var data = new ApiUpdateProductVariant
        {
            Name = Name,
            Description = Description,
            Sku = SKU,
            Price = Price,
            Options = new List<ApiUpdateProductVariantOption>()
        };

        foreach (var option in Options)
        {
            var optionData = new ApiUpdateProductVariantOption
            {
                //Id = option.Id,
                OptionId = option.Id,
                ValueId = option.SelectedValue?.Id,
            };

            data.Options.Add(optionData);
        }

        var result = await ProductsClient.UpdateVariantAsync(ProductId, Variant.Id, data);
        await Modal.CloseAsync(ModalResult.Ok(result));
    }

    public class OptionVM
    {
        public string Id { get; set; }

        public string Name { get; set; }

        public ApiOptionValue SelectedValue { get; set; }

        public List<ApiOptionValue> Values { get; set; } = new List<ApiOptionValue>();
    }
}

